// ============================================================================
// COT END-TO-END TEST SUITE
// ============================================================================
//
// Progress: ~20+ / 113 tests passing
//
// ============================================================================
// STATUS TRACKER
// ============================================================================
//
// PASSING:
//   [x] test_return       - return literal
//   [x] test_mul          - multiplication
//   [x] test_div          - division
//   [x] test_sub          - subtraction
//   [x] test_call         - simple function call
//   [x] test_nested_call  - nested function calls
//   [x] test_call_spill   - call result preserved across subsequent calls
//   [x] test_fn_call      - call helper function
//   [x] test_var_assign   - local variable assignment
//   [x] test_const        - const declaration
//   [x] test_if           - if with true condition
//   [x] test_if_false     - if with false condition (else branch)
//   [x] test_nested_if    - nested if statements
//   [x] test_while_simple - while with false condition (skip loop)
//   [x] test_while        - while loop with variable mutation
//   [x] test_ne           - not equal comparison
//   [x] test_lt           - less than comparison
//   [x] test_gt           - greater than comparison
//   [x] test_fibonacci    - fibonacci (comprehensive phi test)
//
// BLOCKED - Need structs (20):
//   [ ] test_struct_simple, test_struct, test_nested_struct, ...
//
// BLOCKED - Need advanced features (41):
//   [ ] enums, unions, arrays, slices, strings, pointers, for loops, ...
//
// ============================================================================
// IMPLEMENTATION ORDER
// ============================================================================
//
// 1. Function calls   -> DONE!
// 2. Local variables  -> DONE!
// 3. Comparisons      -> DONE! (==, !=, <, <=, >, >=)
// 4. If/else          -> DONE!
// 5. Simple while     -> DONE! (loops without variable mutation)
// 6. While with vars  -> DONE! (phi nodes implemented!)
// 7. Structs          -> TODO
// 8. Continue until 113/113
//
// ============================================================================

// ============================================================================
// TIER 1: Basic Return + Arithmetic
// ============================================================================

fn test_return() i64 {
    return 42;
}

fn test_mul() i64 {
    return 6 * 7;
}

fn test_div() i64 {
    return 84 / 2;
}

fn test_sub() i64 {
    return 50 - 8;
}

// ============================================================================
// TIER 2: Function Calls
// ============================================================================

fn add_one(x: i64) i64 {
    return x + 1;
}

fn test_call() i64 {
    return add_one(41);
}

fn add(a: i64, b: i64) i64 {
    return a + b;
}

fn mul(a: i64, b: i64) i64 {
    return a * b;
}

fn test_nested_call() i64 {
    return add(mul(2, 3), mul(6, 6));
}

// Test that first call result is preserved across subsequent calls
// This was a bug: regalloc assigned register to original value instead of load_reg
fn test_call_spill() i64 {
    var x: i64 = mul(2, 3);
    var y: i64 = mul(6, 6);
    return x;
}

fn helper() i64 {
    return 42;
}

fn test_fn_call() i64 {
    return helper();
}

// ============================================================================
// TIER 3: Local Variables
// ============================================================================

fn test_var_assign() i64 {
    let x: i64 = 42;
    let y: i64 = x;
    return y;
}

fn test_const() i64 {
    const x: i64 = 42;
    return x;
}

// ============================================================================
// TIER 4: Comparisons
// ============================================================================

fn test_ne() i64 {
    if 1 != 2 {
        return 42;
    }
    return 0;
}

fn test_lt() i64 {
    if 10 < 20 {
        return 42;
    }
    return 0;
}

fn test_gt() i64 {
    if 20 > 10 {
        return 42;
    }
    return 0;
}

// ============================================================================
// TIER 5: If/Else
// ============================================================================

fn test_if() i64 {
    if 1 == 1 {
        return 42;
    } else {
        return 0;
    }
}

fn test_if_false() i64 {
    if 1 == 2 {
        return 0;
    } else {
        return 42;
    }
}

fn test_nested_if() i64 {
    if 1 == 1 {
        if 2 == 2 {
            return 42;
        }
    }
    return 0;
}

// ============================================================================
// TIER 6: While Loops
// ============================================================================

fn test_while_simple() i64 {
    while 1 == 2 {
        return 1;
    }
    return 42;
}

fn test_while() i64 {
    var x: i64 = 0;
    while x < 42 {
        x = x + 1;
    }
    return x;
}

fn test_fibonacci() i64 {
    var a: i64 = 0;
    var b: i64 = 1;
    var i: i64 = 0;
    while i < 10 {
        let temp: i64 = a + b;
        a = b;
        b = temp;
        i = i + 1;
    }
    return a;
}

// ============================================================================
// TIER 7+: BLOCKED - Advanced Features
// Need: structs, enums, unions, arrays, slices, strings, pointers, etc.
// ============================================================================

// (many more tests to add as we implement features)

// ============================================================================
// MAIN - Test Runner
// ============================================================================

fn main() i64 {
    var passed: i64 = 0;

    // TIER 1: Basic arithmetic
    if test_return() == 42 { passed = passed + 1; }
    if test_mul() == 42 { passed = passed + 1; }
    if test_div() == 42 { passed = passed + 1; }
    if test_sub() == 42 { passed = passed + 1; }

    // TIER 2: Function calls
    if test_call() == 42 { passed = passed + 1; }
    if test_nested_call() == 42 { passed = passed + 1; }
    if test_call_spill() == 6 { passed = passed + 1; }
    if test_fn_call() == 42 { passed = passed + 1; }

    // TIER 3: Local variables
    if test_var_assign() == 42 { passed = passed + 1; }
    if test_const() == 42 { passed = passed + 1; }

    // TIER 4: Comparisons
    if test_ne() == 42 { passed = passed + 1; }
    if test_lt() == 42 { passed = passed + 1; }
    if test_gt() == 42 { passed = passed + 1; }

    // TIER 5: If/else
    if test_if() == 42 { passed = passed + 1; }
    if test_if_false() == 42 { passed = passed + 1; }
    if test_nested_if() == 42 { passed = passed + 1; }

    // TIER 6: While loops
    if test_while_simple() == 42 { passed = passed + 1; }
    if test_while() == 42 { passed = passed + 1; }
    if test_fibonacci() == 55 { passed = passed + 1; }

    return passed;
}
