// Test SSA Builder
// Note: builder_set_var has a known issue (BUG-029) that causes crashes
// when reading b.current_defs through a function parameter.
// Tests below use only the working functionality.
import "builder.cot"

var g_blocks: [100]Block;
var g_values: [1000]Value;
var g_locals: [50]Local;
var g_all_defs: [50]BlockDefs;
var g_block_map: [50]BlockMapping;
var g_node_values: [500]VarDef;
var g_var_storage: [2000]VarDef;
var g_defs_storage: [10]VarDef;

fn main() i64 {
    let r1: i64 = test_func();
    if r1 != 0 { return r1; }

    let r2: i64 = test_block_defs();
    if r2 != 0 { return r2; }

    let r3: i64 = test_builder_init();
    if r3 != 0 { return r3; }

    let r4: i64 = test_builder_blocks();
    if r4 != 0 { return r4; }

    return 0;
}

fn test_func() i64 {
    var f: Func = undefined;
    func_init(&f, 0, 4, 2,
              &g_blocks[0], 100,
              &g_values[0], 1000,
              &g_locals[0], 50);

    if f.blocks_count != 0 { return 1; }
    if f.entry_block != INVALID_BLOCK { return 2; }

    let entry: i64 = func_new_entry_block(&f);
    if entry != 0 { return 3; }
    if f.blocks_count != 1 { return 4; }

    return 0;
}

fn test_block_defs() i64 {
    var bd: BlockDefs = undefined;
    block_defs_init(&bd, 0, &g_defs_storage[0], 10);

    block_defs_set(&bd, 0, 100);
    block_defs_set(&bd, 1, 101);

    if block_defs_get(&bd, 0) != 100 { return 10; }
    if block_defs_get(&bd, 1) != 101 { return 11; }
    if block_defs_get(&bd, 2) != INVALID_ID { return 12; }

    // Update
    block_defs_set(&bd, 1, 999);
    if block_defs_get(&bd, 1) != 999 { return 13; }

    return 0;
}

fn test_builder_init() i64 {
    var f: Func = undefined;
    func_init(&f, 0, 4, 2,
              &g_blocks[0], 100,
              &g_values[0], 1000,
              &g_locals[0], 50);

    var b: SSABuilder = undefined;
    builder_init(&b, &f,
                 &g_all_defs[0], 50,
                 &g_block_map[0], 50,
                 &g_node_values[0], 500,
                 &g_var_storage[0], 2000);

    if b.current_block != INVALID_BLOCK { return 20; }
    if b.all_defs_count != 0 { return 21; }

    return 0;
}

fn test_builder_blocks() i64 {
    var f: Func = undefined;
    func_init(&f, 0, 4, 2,
              &g_blocks[0], 100,
              &g_values[0], 1000,
              &g_locals[0], 50);

    var b: SSABuilder = undefined;
    builder_init(&b, &f,
                 &g_all_defs[0], 50,
                 &g_block_map[0], 50,
                 &g_node_values[0], 500,
                 &g_var_storage[0], 2000);

    let result: i64 = builder_convert(&b);
    if result != 0 { return 30; }

    if f.entry_block == INVALID_BLOCK { return 31; }
    if f.blocks_count != 1 { return 32; }
    if b.all_defs_count != 1 { return 33; }

    // Create another block
    let b1: i64 = builder_new_block(&b, BlockKind.Plain);
    if b1 != 1 { return 34; }
    if f.blocks_count != 2 { return 35; }

    return 0;
}
