// genssa Test - Tests for the SSA to machine code generator
// Run with: ./zig-out/bin/cot cot0/codegen/genssa_test.cot -o /tmp/genssa_test && /tmp/genssa_test

import "genssa.cot"
import "../frontend/types.cot"

extern fn write(fd: i32, buf: *u8, count: i64) i64;

fn print_str(s: string) {
    write(1, s.ptr, len(s));
}

fn print_num(n: i64) {
    var ch: u8 = 48;
    if n == 0 {
        write(1, &ch, 1);
        return;
    }

    var val: i64 = n;
    if val < 0 {
        print_str("-");
        val = 0 - val;
    }

    var digits: [20]u8;
    var count: i64 = 0;

    while val > 0 and count < 20 {
        let digit: i64 = val - (val / 10) * 10;
        digits[count] = @intCast(u8, 48 + digit);
        val = val / 10;
        count = count + 1;
    }

    while count > 0 {
        count = count - 1;
        write(1, &digits[count], 1);
    }
}

// Storage arrays
var g_ssa_blocks: [100]Block;
var g_ssa_values: [1000]Value;
var g_ssa_locals: [50]Local;
var g_code: [65536]u8;
var g_bstart: [100]i64;
var g_branches: [100]Branch;

fn main() i64 {
    print_str("genssa Test\n");
    print_str("===========\n\n");

    let r1: i64 = test_genstate_init();
    if r1 != 0 { return r1; }

    let r2: i64 = test_emit_inst();
    if r2 != 0 { return r2; }

    let r3: i64 = test_genssa_basic();
    if r3 != 0 { return r3; }

    print_str("\nAll genssa tests passed!\n");
    return 0;
}

fn test_genstate_init() i64 {
    print_str("Test: genstate_init - ");

    var f: Func = undefined;
    func_init(&f, 0, 4, TYPE_I64,
              &g_ssa_blocks[0], 100,
              &g_ssa_values[0], 1000,
              &g_ssa_locals[0], 50);

    var gs: GenState = undefined;
    genstate_init(&gs, &f,
                  &g_code[0], 65536,
                  &g_bstart[0], 100,
                  &g_branches[0], 100);

    if gs.code_count != 0 { print_str("FAIL (code_count)\n"); return 1; }
    if gs.branches_count != 0 { print_str("FAIL (branches_count)\n"); return 2; }
    if gs.current_block != INVALID_BLOCK { print_str("FAIL (current_block)\n"); return 3; }

    print_str("PASS\n");
    return 0;
}

fn test_emit_inst() i64 {
    print_str("Test: emit_inst - ");

    var f: Func = undefined;
    func_init(&f, 0, 4, TYPE_I64,
              &g_ssa_blocks[0], 100,
              &g_ssa_values[0], 1000,
              &g_ssa_locals[0], 50);

    var gs: GenState = undefined;
    genstate_init(&gs, &f,
                  &g_code[0], 65536,
                  &g_bstart[0], 100,
                  &g_branches[0], 100);

    // Emit a NOP instruction (0xd503201f)
    emit_inst(&gs, encode_nop());

    if gs.code_count != 4 { print_str("FAIL (code_count)\n"); return 10; }

    // Check the encoded instruction (little-endian)
    // NOP = 0xd503201f
    // So bytes should be: 0x1f, 0x20, 0x03, 0xd5
    let byte0: i64 = @intCast(i64, g_code[0]);
    let byte1: i64 = @intCast(i64, g_code[1]);
    let byte2: i64 = @intCast(i64, g_code[2]);
    let byte3: i64 = @intCast(i64, g_code[3]);

    if byte0 != 31 { print_str("FAIL (byte0)\n"); return 11; }     // 0x1f
    if byte1 != 32 { print_str("FAIL (byte1)\n"); return 12; }     // 0x20
    if byte2 != 3 { print_str("FAIL (byte2)\n"); return 13; }      // 0x03
    if byte3 != 213 { print_str("FAIL (byte3)\n"); return 14; }    // 0xd5

    print_str("PASS\n");
    return 0;
}

fn test_genssa_basic() i64 {
    print_str("Test: genssa basic - ");

    // Create a simple function that returns 42
    var f: Func = undefined;
    func_init(&f, 0, 4, TYPE_I64,
              &g_ssa_blocks[0], 100,
              &g_ssa_values[0], 1000,
              &g_ssa_locals[0], 50);

    let entry: i64 = func_new_entry_block(&f);

    // Emit: return 42
    let const_val: *Value = func_emit_const_int(&f, 42, TYPE_I64);
    const_val.reg = X0;
    let ret_val: *Value = func_emit_return(&f, const_val);
    func_emit_return_block(&f);

    // Generate machine code
    var gs: GenState = undefined;
    genstate_init(&gs, &f,
                  &g_code[0], 65536,
                  &g_bstart[0], 100,
                  &g_branches[0], 100);

    let result: i64 = genssa(&gs);

    if result != 0 { print_str("FAIL (genssa error)\n"); return 20; }
    if gs.code_count == 0 { print_str("FAIL (no code emitted)\n"); return 21; }

    print_str("PASS (");
    print_num(gs.code_count);
    print_str(" bytes emitted)\n");
    return 0;
}
